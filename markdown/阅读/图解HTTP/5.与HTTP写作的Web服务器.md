## 与HTTP协作的Web服务器

一台Web服务器可以搭建多个独立域名的Web网站，也可以作为通信路径上的中转服务器提升传输效率

### 5.1 用单台虚拟主机实现多个域名

HTTP/1.1 规范允许一台HTTP服务器搭建多个Web站点。

在相同的IP地址下，由于虚拟主机可以寄存多个不同主机和域名的Web网站，因此在发送HTTP请求时，必须在Host首部内完整指定主机名或域名的URI

### 5.2 通信数据转发程序：代理、网关、隧道

HTTP通信时，除客户端和服务器以外，还有一些用于通信数据转发的应用程序，例如代理、网关和隧道。它们可以配合服务器工作。

这些应用程序和服务器可以将请求转发给通信线路上的下一站服务器，并且能接受从那台服务器发送的响应在转发给客户端。

* 代理

  代理是一种有转发功能的应用程序，他扮演了位于服务器和客户端“中间人”的角色，接收由客户端发送请求并转发给服务器，同时也接受服务器的返回的响应并转发给客户端。

* 网关

  网关是转发其他服务器通信数据的服务器，接收从客户端发送来的请求时，他就像自己拥有资源的服务器一样对请求进行处理。有时客户端可能都不会察觉，自己的通信目标是一个网关。

* 隧道

  隧道是在相隔甚远的客户端和服务器两者之间进行中转，并保持双方通信连接的应用程序。

#### 5.2.1 代理

代理服务器的基本行为就是接收客户端发送的请求后转发给其他服务器。代理不改变请求的URI，会直接发送给前方持有资源的目标服务器。

持有资源实体的服务器被称为源服务器。从源服务器返回的响应经过代理服务器后再传给客户端

![5.2.1代理](https://github.com/old-shoes/blog/blob/master/markdown/%E9%98%85%E8%AF%BB/%E5%9B%BE%E8%A7%A3HTTP/img/5.%E4%B8%8EHTTP%E5%86%99%E4%BD%9C%E7%9A%84Web%E6%9C%8D%E5%8A%A1%E5%99%A8/5.2.1%E4%BB%A3%E7%90%86.png)

图： 每次通过dialing服务器转发请求或响应时，会追加写入 **Via ** 首部信息

![5.2.1 代理-2](https://github.com/old-shoes/blog/blob/master/markdown/%E9%98%85%E8%AF%BB/%E5%9B%BE%E8%A7%A3HTTP/img/5.%E4%B8%8EHTTP%E5%86%99%E4%BD%9C%E7%9A%84Web%E6%9C%8D%E5%8A%A1%E5%99%A8/5.2.1%E4%BB%A3%E7%90%86-2.png)

使用代理服务器的理由有： 利用缓存技术减少网络带宽的流量，组织内部针对特定网站的访问控制，以获取访问日志为主要目的，等等。

代理的方法按两种基准分类。一种是是否使用缓存，另一种是是否会修改报文。

* 缓存代理

  代理转发响应时，缓存代理（Caching Proxy）会预先将资源的副本（缓存）保存在代理服务器上。

  当代理再次接受到对应相同资源的请求时，就可以不从源服务器那里获取资源，而是将之前缓存的资源作为响应返回

* 透明代理

  转发请求或响应是，不对报文做任何加工的代理类型被称为透明代理（Transparent Proxy）。反之，对报文内容进行加工的代理被称为非透明代理



####5.2.2 网关

> 转发其他服务器通信数据的服务器，接收从客户端发送来的请 求时，它就像自己拥有资源的源服务器一样对请求进行处理。有时客 户端可能都不会察觉，自己的通信目标是一个网关。

![5.2.2 网关--1](https://github.com/old-shoes/blog/blob/master/markdown/%E9%98%85%E8%AF%BB/%E5%9B%BE%E8%A7%A3HTTP/img/5.%E4%B8%8EHTTP%E5%86%99%E4%BD%9C%E7%9A%84Web%E6%9C%8D%E5%8A%A1%E5%99%A8/5.2.2%E7%BD%91%E5%85%B3--1.png)

图： 利用网关可以由HTTP请求转化为其他协议通信

网关的工作机制和代理十分相似。而网关能使通信线路上的服务器提供非HTTP协议服务。

利用网关能提高通信的安全性，因为可以在客户端和网关之间的通信线路上加密以确保连接的安全。

比如：

* 网关可以连接数据库，使用SQL语句查询数据。
* 在Web购物网站上进行信用卡结算时，网关课以和信用卡结算系统联动

### 5.2.3 隧道

隧道可以按照要求建立起一条鱼其他服务器的通信线路，届时使用SSL等加密手段进行通信。隧道的目的是确保客户端能与服务器进行安全的通信。

隧道本身不回去解析HTTP请求。也就是说，请求保持原样中转给之后的服务器。隧道会在通信双方断开连接时结束。

![5.2.3 隧道](https://github.com/old-shoes/blog/blob/master/markdown/%E9%98%85%E8%AF%BB/%E5%9B%BE%E8%A7%A3HTTP/img/5.%E4%B8%8EHTTP%E5%86%99%E4%BD%9C%E7%9A%84Web%E6%9C%8D%E5%8A%A1%E5%99%A8/5.2.3%E9%9A%A7%E9%81%93.png)

## 5.3 保存资源的缓存

缓存是指代理服务器或客户端本地磁盘内保存的资源副本。

>利用缓存可以减少对源服务器的访问，因此也就是节省了通信流量和通信时间

缓存服务器是代理服务器的一种，并归类在缓存代理类型中。换句话说，当代理转发从服务器返回的响应时，代理服务器将会保存一份资源的副本。

![5.3 保存资源的缓存-1](https://github.com/old-shoes/blog/blob/master/markdown/%E9%98%85%E8%AF%BB/%E5%9B%BE%E8%A7%A3HTTP/img/5.%E4%B8%8EHTTP%E5%86%99%E4%BD%9C%E7%9A%84Web%E6%9C%8D%E5%8A%A1%E5%99%A8/5.3%E4%BF%9D%E5%AD%98%E8%B5%84%E6%BA%90%E7%9A%84%E7%BC%93%E5%AD%98-1.png) 

### 5.3.1缓存的有效期限

即便缓存服务器哪有缓存，也不能保证每次都会返回对同资源的请求。因为这关系到被缓存资源的有效性问题

当遇上源服务器上的资源更新时，如果还是使用不变的缓存，那就回演变成返回更新前的“旧”资源

即使存在缓存，也会应为**客户端的要求、缓存的有效期等**因素，向源服务器确认资源的有效性。若判断缓存失效，缓存服务器将会再次从源服务器上获取“新”资源

![5.3.1缓存的有效期限-1](https://github.com/old-shoes/blog/blob/master/markdown/%E9%98%85%E8%AF%BB/%E5%9B%BE%E8%A7%A3HTTP/img/5.%E4%B8%8EHTTP%E5%86%99%E4%BD%9C%E7%9A%84Web%E6%9C%8D%E5%8A%A1%E5%99%A8/5.3.1%E7%BC%93%E5%AD%98%E7%9A%84%E6%9C%89%E6%95%88%E6%9C%9F%E9%99%90-1.png)

### 5.3.2 客户端的缓存

缓存不仅可以存在于**缓存服务器**内，还可以存在**客户端浏览器中**。

以 **Internet Explorer **（万恶的IE）程序为例，把客户端缓存称为**临时网络文件（Temporary Internet File）**

浏览器缓存如果有效，就不必在想服务器请求相同的资源了，可以直接从本地磁盘内读取。

另外，和缓存服务器相同的一点是，当判定缓存过期后，会向原服务器确认资源的有效性。若判断浏览器缓存失效，浏览器会再次请求新资源。

> 在HTTP出现之前的协议
>
> 在HTTP普及之前，也就是从互联网的诞生期至今，曾出现过各式各样的协议，在**HTTP**规范确立之际，制定者们参考了那些协议的功能。看下边
>
> **FTP（File Transfer Protocol）**
>
> 传输文件时使用的协议。该协议历史久远，可追溯到1973年前后，比TCP/IP协议族的出现还要早。虽然他在1995年被HTTP的流量（Traffic）超越，但时至今日，仍被广泛沿用
>
> **NNTP（Network News Transfer Protocol）**
>
> 用于NetNews 电子会议室内传送消息的协议。在1986年前后出现，属于比较古老的一类协议。现在，利用Web交换信息已成主流，所以该协议已经不怎么使用。
>
> **Archie**
>
> 搜索anonymous FTP 公开的文件信息的协议，不怎么使用。
>
> **WAIS（Wide Area Information Servers）**
>
> 以关键词检索多个数据库使用的协议。不怎么使用。
>
> **Gopher**
>
> 查找于互联网连接的看计算机内信息的协议，不怎么使用。

